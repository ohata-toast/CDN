## Content Delivery > CDN > コンソール使用ガイド

この文書はTOAST CDNコンソールでCDNサービスを構成して利用する方法を説明します。

## CDNサービス作成

**Contents Delivery > CDNのCDNサービス**タブで**作成**ボタンをクリックすると、**CDNサービス作成**ウィンドウが表示されます。
CDNサービスドメインは**[サービスID].toastcdn.net**の形式で自動作成されます。所有しているドメインをサービスドメインに利用するには、**ドメインエイリアス**(Domain Alias)機能を利用してサービスできます。
作成をリクエストした後、サービスの配布が完了するまで最大2時間かかります。配布が完了した後、サービスを利用できます。

### 基本情報 
基本情報を設定します。
![CDNサービス作成-基本情報](https://static.toastoven.net/prod_cdn/v2/console-cdn-create-default.png)

- **サービス地域**
  GLOBALサービス地域は、全世界の拠点にあるCDNエッジサーバーを通してCDNサービスを提供します。
 ただし、**中国とロシア**はサービス地域から除外されます。

- **説明**
  CDNサービスの説明を追加します。

- **ドメインエイリアス**
  TOSAT CDNは基本的に**[サービスID].toastcdn.net**形式のCDNサービスドメインアドレスを提供しています。
 基本サービスドメインアドレスではない所有ドメインを通してCDNサービスを利用するには**ドメインエイリアス**に所有しているドメインを設定して利用できます。
 所有しているドメインでHTTPSプロトコルサービスを利用するには、まず**証明書管理**タブで証明書を発行した後、ドメインエイリアスを設定してください。
 ドメインエイリアスを設定した後は、ドメインのDNSサービス提供業者で、次のようにCNAMEレコードを登録する必要があります。(DNS設定関連はDNSサービス提供業者にお問い合わせください。)
    - レコードタイプ：**CNAME**
    - レコード名：**[ドメインエイリアスに登録したドメイン]**
    - レコード値(Rdata)：**[サービスID].toastcdn.net**
    - TTL：任意の値

- **コールバック**
  CDNサービス作成と変更作業(修正、一時停止/再開、削除)は数時間かかります。
 作業が完了した後、設定したコールバックURLに変更状態とCDN設定情報を受け取るにはコールバックを設定してください。コールバックを通して伝達される情報はAPIガイド文書を参照してください。
    1. **HTTP Method**と**コールバックURL**を入力します。
    2. Query ParameterにCDNサービス変更作業の結果を受け取るには、**コールバックURL**に次のPath変数を含めて入力してください。(例: http://callback.url?appKey={appKey}&status={status}&isSuccessful={isSuccessful})

| Path変数 | 説明 | サンプル伝達値 |
| ------------- | --- | ------- |
| {appKey} | CDNサービスのアプリキー | コンソールで発行されたアプリキー |
| {domain} | CDNサービス名 | [サービスID].cdn.toastcloud.comまたは[サービスID].toastcdn.net |
| {status} | 現在のCDNサービスの状態 | OPEN、SUSPEND、CLOSE、ERROR |
| {isSuccessful} | サービス変更作業が成功したか(API V1.0はサポートしません) | "true"または"false" |

### オリジンサーバー
CDNサービスを通して配布する、原本ファイル提供サーバーを設定します。
![CDNサービス作成-基本情報](https://static.toastoven.net/prod_cdn/v2/console-cdn-create-origin.png)

- **オリジンサーバー**
オリジンサーバーはCDNサービスを通して配布する原本ファイルの提供サーバーです。オリジンサーバーはIPv4またはドメイン(FQDN：Fully Qualified Domain Name)形式で入力することができます。IPアドレスは変更される可能性が高いため、ドメインで設定することを推奨します。 
 運用中のオリジンサーバーがない場合は、TOAST Computeサービスのインスタンスを使用するか、TOAST StorageサービスのObject Stroageを利用してください。
  CDNサービスドメインを通してHTTPS転送をサポートするには、オリジンサーバーがHTTPSレスポンスをサポートする必要があります。 
これはオリジンサーバーにTOAST CDNが信頼する証明書のインストールが必要であることを意味します。 
 信頼する証明書は[表1]信頼する証明書リストを参照してください。 
 もしオリジンサーバーがHTTPレスポンスをサポートできない場合**原本リクエストHTTPプロトコルダウングレード**設定を利用してください。 
 ただし、**原本リクエストHTTPプロトコルのダウングレード**は制約があるため、オリジンサーバーがHTTPSプロトコルをサポートすることを推奨します。 

**[表1]信頼する証明書リスト**

| Common name| Expire Date |SHA-1 Fingerprint |
|---|---|---|
|SecureTrust CA|1.Jan.30|8782c6c304353bcfd29692d2593e7d44d934ff11|
|Entrust.net Certification Authority (2048)|24.Jul.29|503006091d97d4f5ae39f7cbe7927d7d652d3431|
|DigiCert Global Root CA|10.Nov.31|a8985d3a65e5e5c4b2d7d66d40c6dd2fb19c5436|
||30.Sep.23|36b12b49f9819ed74c9ebc380fc6568f5dacb2f7|
|QuoVadis Root CA 2 G3|13.Jan.42|093c61f38b8bdc7d55df7538020500e125f5c836|
|thawte Primary Root CA|17.Jul.36|91c6d6ee3e8ac86384e548c299295c756c817b81|
|Go Daddy Root Certificate Authority - G2|1.Jan.38|47beabc922eae80e78783462a79f45c254fde68b|
|GeoTrust Primary Certification Authority|17.Jul.36|323c118e1bf7b8b65254e2e2100dd6029037f096|
|VeriSign Class 3 Public Primary Certification Authority - G4|19.Jan.38|22d5d8df8f0231d18df79db7cf8a2d64c93f6c3a|
|Entrust Root Certification Authority|28.Nov.26|b31eb1b740e36c8402dadc37d44df5d4674952f9|
||29.May.29|5f3b8cf2f810b37d78b4ceec1919c37334b9c774|
|AffirmTrust Commercial|31.Dec.30|f9b5b632455f9cbeec575f80dce96e2cc7b278b7|
|Amazon Root CA 4|26.May.40|f6108407d6f8bb67980cc2e244c2ebae1cef63be|
|Certum CA|11.Jun.27|6252dc40f71143a22fde9ef7348e064251b18118|
|DST Root CA X3|30.Sep.21|dac9024f54d8f6df94935fb1732638ca6ad77c13|
|TC TrustCenter Class 2 CA II|1.Jan.26|ae5083ed7cf45cbc8f61c621fe685d794221156e|
|SwissSign Gold CA - G2|25.Oct.36|d8c5388ab7301b1b6ed47ae645253a6f9f1a2761|
|USERTrust ECC Certification Authority|19.Jan.38|d1cbca5db2d52a7f693b674de5f05a1d0c957df0|
|QuoVadis Root CA 2|25.Nov.31|ca3afbcf1240364b44b216208880483919937cf7|
|COMODO ECC Certification Authority|19.Jan.38|9f744e9f2b4dbaec0f312c50b6563b8e2d93c311|
|USERTrust RSA Certification Authority|19.Jan.38|2b8f1b57330dbba2d07a6c51f70ee90ddab9ad8e|
|ISRG Root X1|4.Jun.35|cabd2a79a1076a31f21d253635cb039d4329a5e8|
|DigiCert High Assurance EV Root CA|10.Nov.31|5fb7ee0633e259dbad0c4c9ae6d38f1a61c7dc25|
|VeriSign Class 3 Public Primary Certification Authority - G5|17.Jul.36|4eb6d578499b1ccf5f581ead56be3d9b6744a5e5|
|GlobalSign|15.Dec.21|75e0abb6138512271c04f85fddde38e4b7242efe|
|QuoVadis Root CA 3|25.Nov.31|1f4914f7d874951dddae02c0befd3a2d82755185|
|GlobalSign|18.Mar.29|d69b561148f01c77c54578c10926df5b856976ad|
|Starfield Services Root Certificate Authority - G2|1.Jan.38|925a8f8d2c6d04e0665f596aff22d863e8256f3f|
|Baltimore CyberTrust Root|13.May.25|d4de20d05e66fc53fe1a50882c78db2852cae474|
|AAA Certificate Services|1.Jan.29|d1eb23a46d17d68fd92564c2f1f1601764d8e349|
|Amazon Root CA 3|26.May.40|0d44dd8c3c8c1a1a58756481e90f2e2affb3d26e|
|VeriSign Class 3 Public Primary Certification Authority - G3|17.Jul.36|132d0d45534b6997cdb2d5c339e25576609b5cc6|
|GlobalSign Root CA|28.Jan.28|b1bc968bd4f49d622aa89a81f2150152a41d829c|
|Actalis Authentication Root CA|22.Sep.30|f373b387065a28848af2f34ace192bddc78e9cac|
|AffirmTrust Networking|31.Dec.30|293621028b20ed02f566c532d1d6ed909f45002f|
|AffirmTrust Premium|31.Dec.40|d8a6332ce0036fb185f6634f7d6a066526322827|
|QuoVadis Root Certification Authority|18.Mar.21|de3f40bd5093d39b6c60f6dabc076201008976c9|
||6.Jun.37|feb8c432dcf9769aceae3dd8908ffd288665647d|
|GeoTrust Primary Certification Authority - G3|2.Dec.37|039eedb80be7a03c6953893b20d2d9323a4c2afd|
|thawte Primary Root CA - G2|19.Jan.38|aadbbc22238fc401a127bb38ddf41ddb089ef012|
|VeriSign Universal Root Certification Authority|2.Dec.37|3679ca35668772304d30a5fb873b0fa77bb70d54|
|Cybertrust Global Root|15.Dec.21|5f43e5b1bff8788cac1cc7ca4a9ac6222bcc34c6|
|Global Chambersign Root|1.Oct.37|339b6b1450249b557a01877284d9e02fc3d2d8e9|
|SwissSign Silver CA - G2|25.Oct.36|9baae59f56ee21cb435abe2593dfa7f040d11dcb|
|Amazon Root CA 1|17.Jan.38|8da7f965ec5efc37910f1c6e59fdc1cc6a6ede16|
|Entrust Root Certification Authority - G2|8.Dec.30|8cf427fd790c3ad166068de81e57efbb932272d4|
|Amazon Root CA 2|26.May.40|5a8cef45d7a69859767a8c8b4496b578cf474b1a|
|DigiCert Assured ID Root CA|10.Nov.31|0563b8630d62d75abbc8ab1e4bdfb5a899b24d43|
||30.Jun.34|2796bae63f1801e277261ba0d77770028f20eee4|
|COMODO Certification Authority|1.Jan.30|6631bf9ef74f9eb6c9d5a60cba6abed1f7bdef7b|
|AddTrust External CA Root|30.May.20|02faf3e291435468607857694df5e45b68851868|
|COMODO RSA Certification Authority|19.Jan.38|afe5d244a8d1194230ff479fe2f897bbcd7a8cb4|
|thawte Primary Root CA - G3|2.Dec.37|f18b538d1be903b6a6f056435b171589caf36bf2|
|DigiCert Global Root G3|15.Jan.38|7e04de896a3e666d00e687d33ffad93be83d349e|
|GeoTrust Global CA|21.May.22|de28f4a4ffe5b92fa3c503d1a349a7f9962a8212|
|DigiCert Global Root G2|15.Jan.38|df3c24f9bfd666761b268073fe06d1cc8d4f82a4|
  
- **オリジンサーバーポート**  
 オリジンサーバーはWebプロトコルをサポートするサービスで運用する必要があります。運用中のHTTP/HTTPSプロトコルのサービスポート番号を設定できます。 
 オリジンサーバーのポートはHTTPまたはHTTPSポートのいずれか1つを入力する必要があり、設定していないポートはポートHTTP:80、HTTPS:443に設定されます。 
 オリジンサーバーのポートは制限されたポートのみ設定できます。設定できるポート番号は[表2]使用可能なオリジンサーバーポート番号を参照してください。 

**[表2]使用可能なオリジンサーバーポート番号**

|ポート番号|
|---|
|72, 488, 1080, 1443, 7070|
|8000-9001|
|11080-11110|
|80-89|
|591, 1088, 2080, 7612|
|12900-12949|
|443, 777, 1111, 7001, 7777|
|9901-9908|
|45002|

- **ソースパス**  
 ソースパスは原本ファイルのパスのうち、下層パスを設定します。ソースパスに指定されたパスは省略してコンテンツをリクエストできます。

> **[例]ソースパスを /files/imagesに設定した場合** 
> - 原本ファイルURL：http://your.origin.com/**files/images**/logo.png 
> - CDNサービスURL：http://[サービスID].toastcdn.net/logo.png
> - CDNサービスURLでソースパス(/files/images)を省略してリクエストできます。 

- **原本リクエストHTTPプロトコルのダウングレード**  
  CDNエッジ(edge)サーバーは、オリジンサーバーに原本ファイルをリクエストする時、原本リクエスト(clientの原本Request)のサービスプロトコル(HTTP/HTTPS)でリクエストします。 
 すなわち、クライアントからHTTPSでリクエストし、 オリジンサーバーがHTTPSレスポンスをサポートしていない場合、 CDNエッジサーバーからオリジンサーバーにリクエストする時は、 HTTPSプロトコルでリクエストするため、原本ファイルを受け取れません。
オリジンサーバーがHTTPプロトコルのみサポートしている場合**オリジンサーバーHTTPプロトコルダウングレード**設定を使用するとCDNエッジサーバーからオリジンサーバーにリクエストする時、HTTPSプロトコルをHTTPプロトコルへダウングレードしてオリジンサーバーへリクエストできます。
 これはクライアント→ CDNエッジサーバー間は暗号化通信(HTTPS)で通信し、CDNエッジサーバー→オリジンサーバー間は非暗号化通信(HTTP)で通信することを意味します。 
 原本リクエストHTTPプロトコルのダウングレードは、次の制約があるため、必ず確認してから使用してください。 
  
> **[注意]原本リクエストHTTPプロトコルのダウングレードの制約事項**
> 1. サイトアドレス全体はプロトコルのダウングレードができません。(例：オリジンサーバーのサイトアドレス全体**www.toast.com**はダウングレードできません。)
> 2. GET、HEADおよびOPTIONSメソッド以外のメソッドはサポートされません。 
> 3. CDNサーバーからオリジンサーバーにダウングレードをリクエストする時、次のヘッダは除外される場合があります。
>    Origin, Referer, Cookie, Cookie2, sec-\*, proxy-\*

- **Forward Host Header**
  CDNサーバーがオリジンサーバーへ原本ファイルをリクエストする時に伝達する**Host**ヘッダ値を設定します。
 オリジンサーバーがName-based virtual hostで運用中の場合、**リクエストホストヘッダ**設定が必要な場合もあります。オリジンサーバーの運用形態に従って適切な設定値を選択してください。

    - **原本ホスト名**：オリジンサーバーのホスト名をHostヘッダに設定します。 
    - **リクエストホストヘッダ**：クライアントリクエストのHostヘッダに設定します。

### キャッシュ

CDNキャッシュ動作設定とキャッシュ時間を設定できます。
![CDNサービス作成-キャッシュ](https://static.toastoven.net/prod_cdn/v2/console-cdn-create-cache.png)

- **キャッシュ時間設定**
 オリジンサーバーのCache Controlレスポンスヘッダを通してキャッシュを設定できます。 
    - **原本設定を使用**：オリジンサーバーのレスポンスで提供したキャッシュ制御ヘッダ(Cache-Control、Expires)を優先して適用します。もしオリジンサーバーのレスポンスにキャッシュ制御ヘッダ(Cache-Control、Expires)が有効ではないか、存在しない場合、キャッシュ時間(秒)に指定した時間キャッシュします。**原本設定を使用**オプションがデフォルト値です。
    - **ユーザー設定を使用**：キャッシュ時間(秒)に指定した時間、キャッシュします。

> **[参考]キャッシュ時間のデフォルト値と有効範囲**
> キャッシュ時間のデフォルト値は0です。デフォルト値を0に設定すると、キャッシュ時間は604,800(単位/秒)=1週間です。
> キャッシュ時間は、デフォルト値の0から2,147,483,647(単位/秒)まで入力できます。

### リファラー(Referer)ヘッダアクセス管理
Refererリクエストヘッダにコンテンツのアクセス管理を設定します。
![CDNサービス作成-キャッシュ](https://static.toastoven.net/prod_cdn/v2/console-cdn-create-cache.png)

Refererリクエストヘッダは、現在リクエストされたページリンクより前のWebページアドレスを含みます。Refererリクエストヘッダを通して、どの経路でリクエストが流入したかを把握できます。リファラー(Referer)ヘッダアクセス管理は、特定Refererリクエストヘッダのみユーザーコンテンツにアクセスできるよう設定できます。
正規表現形式で入力できます。複数入力する場合はラインを分けて入力します。

- **Blacklist(ブラックリスト)タイプ**：
    * 特定Refererリクエストヘッダのみアクセスを制限する時に適しています。
* Refererリクエストヘッダの値が設定した正規表現式にマッチする文字列の場合、コンテンツアクセスが制限されます。マッチしない文字列の場合、コンテンツアクセスが許可されます。
- **Whitelist(ホワイトリスト)タイプ**：
    * 特定Refererリクエストヘッダのみアクセスを許可する時に適しています。
    * Refererリクエストヘッダの値が正規表現式にマッチする文字列の場合、コンテンツアクセスが許可されます。マッチしない文字列の場合、コンテンツアクセスが制限されます。

> [注意]
> Refererリクエストヘッダがない場合、アクセス制御は動作しません。
>
> [例]
> * タイプ：ホワイトリスト(Whitelist)
> * 正規表現：`^https://[a-zA-Z0-9._-]*\.toast\.com/.*`
> 任意のtoast.comサブドメインの下層パスからリソースを要求した場合にのみ、コンテンツアクセスを許可するようになります。
>
> **[参考]正規表現式のエスケープ文字**
> 一部の文字は、正規表現で特殊文字として扱われます。
> 例えば、正規表現でドット(`.`)は、すべての文字にマッチする特殊文字です。
> 特殊文字としての意味ではない一般文字そのままの解釈が必要な場合は、エスケープ文字バックスラッシュ(`\`)を特殊文字の前に追加してください。(例： `\.`)
> 正規表現の特殊文字は`^ . [ ] $ ( ) | * + ? { } \`などがあります。
> 複数のリファラーを制御する場合、次のラインに連続して入力します。
> APIで複数のリファラーを設定する時は\nトークンで区切って入力します。


## 設定

### CDNサービスの設定変更
サービスドメイン名と地域以外のCDNサービス設定を変更できます。 
![CDNサービスの修正を有効化](https://static.toastoven.net/prod_cdn/v2/console-cdn-modify1.png)
1. 変更するCDNサービスをCDNサービスリストから選択します。
2. 画面下、**設定**タブの**修正**ボタンをクリックします。

次のように変更可能な項目が有効になります。
![CDNサービスの修正を確認](https://static.toastoven.net/prod_cdn/v2/console-cdn-modify2.png)

* 変更する設定内容を修正します。 
* **確認**ボタンをクリックして、変更を完了します。
* 説明とコールバック以外の設定変更はCDNサーバー全体に適用されるため、修正作業に時間がかかる場合もあります。

**修正作業は数十分以内に完了しますが、ドメインエイリアス設定の変更時は数時間かかる場合もあります。**

> **[参考] CDNサービス修正中配布状態とサービス状態** 
> サービス修正作業が進行中の場合は既存CDNサービス設定で運用されます。
> もし修正作業が失敗した場合、既存設定情報にロールバックされ、CDNサービスリストの配布状態が赤色で表示されます。修正作業が失敗する原因は、設定情報のエラーか、内部的なエラーの発生です。

### CDNサービスの一時停止と再開
CDNサービスを一時的に中断または、再開することができます。


1. 一時停止するCDNサービスを選択します。
2. **一時停止**ボタンをクリックします。
![CDNサービス-一時停止](https://static.toastoven.net/prod_cdn/v2/console-cdn-pause.png)
3. 証明書の連携をしているCDNサービスは、証明書の無効警告案内が表示されます。警告案内文言を参照して証明書の無効を回避するには、証明書更新開始日の前にCDNサービスを再開する必要があります。
![CDNサービス-一時停止](https://static.toastoven.net/prod_cdn/v2/console-cdn-restart.png)
4. 一時停止状態のCDNサービスを再開するには再開するCDNサービスを選択します。
5. **再開**ボタンをクリックします。




> **[参考]一時停止と再開動作の遅延**
> CDNサービスの一時停止と再開は、CDNサービスドメインのDNSレコードを変更して動作します。 
> したがってキャッシュDNSサーバーでTTLの間キャッシュされているか、DNSの配信に応じて、一時停止/再開が完了しても、即時に一時停止/再開が動作しない場合もあります。

> **[注意]発行された証明書が連携されているCDNサービスの一時停止**
> 証明書を連携しているCDNサービスを一時停止する場合、証明書の更新ができません。
> **証明書管理** > 証明書リストの **証明書更新開始日**の前にCDNサービスを再開してください。
> 証明書更新開始日から5日間は、証明書更新期間のため、この期間に一時停止を行うと証明書が無効になる場合もあるため、注意してください。


### CDNサービスの削除 
CDNサービスを削除します。削除すると復旧できませんので注意してください。 

1. 削除するCDNサービスを選択します。
2. **削除**ボタンをクリックします。
![CDNサービス-削除](https://static.toastoven.net/prod_cdn/v2/console-cdn-delete.png)
3. 証明書が連携されているCDNサービスは、証明書無効警告案内が表示されます。警告案内文言を参照して証明書が無効にならないようにするためには、サービス中の他のCDNサービスに証明書を連携してください。


> **[参考] CDNサービス削除の所要時間**
> CDNサービス削除作業は数時間(最大2～3時間)かかる場合があります。

> **[注意]発行された証明書が連携されているCDNサービスの削除**
> 証明書が連携されているCDNサービスを削除する場合、証明書の更新ができません。
> **証明書管理** > 証明書リストの**証明書更新開始日**より前にサービス中の他CDNサービスへ連携してください。
> 証明書更新開始日から5日間は、証明書更新期間のため、この期間に削除を行うと証明書が無効になる場合があるため、注意してください。


## CDNキャッシュの再配布
CDNキャッシュサーバーは、キャッシュ設定に従って、指定された時間、オリジンサーバーのファイルをキャッシュします。これは原本ファイルが変更されてもキャッシュ時間は変更された原本ファイルを維持することを意味します。 
変更された原本ファイルに即時にアップデートされるようにするには、**キャッシュ再配布**リクエストを行う必要があります。
キャッシュ再配布を行うと、リクエストしたコンテンツの古いキャッシュデータを削除し、オリジンサーバーから新しい原本ファイルを再度キャッシュします。 

1. 変更したいサービスをCDNサービスリストから選択します。
2. **キャッシュ再配布**タブをクリックします。
![CDNキャッシュ再配布](https://static.toastoven.net/prod_cdn/v2/console-cdn-purge.png)

3. キャッシュ再配布タイプを選択します。
  - CDNサービスドメインに応じてサポートされるキャッシュ再配布タイプとリクエスト様式が異なるため注意してください。 
  - **[サービスID].toastcdn.net**サービスドメインの再配布タイプとリクエスト様式
    * 特定ファイル：再配布するコンテンツのURLを入力します。リクエストしたURLについてのみキャッシュが再配布されるため、ドメインエイリアスに複数のサービスドメインアドレスがある場合、各URLにリクエストする必要があります。
      * 例)基本サービスドメインアドレス： http://[サービスID].toastcdn.net/path/to/file1.jpg
      * 例)ドメインエイリアスドメインアドレス： http://customer.domain.com/path/to/file1.jpg
    * 全体ファイル：キャッシュされたファイルをすべて削除します。オリジンサーバーに膨大なトラフィックが流入する場合もあるため注意してください。
  - **[サービスID].cdn.toastcloud.com**サービスドメインの再配布タイプとリクエスト様式
    * 特定ファイル：再配布するコンテンツのパスを入力します。
      * 例) /path/to/file1.jpg
    * ワイルドカード：ファイル名とパス名にワイルドカード文字を利用できます。(ワイルドカードは**\*.cdn.toastcloud.com**サービスのみ提供されます。)
      * \*：任意の文字列
      * ?：1個の文字
      * \：エスケープ文字
          * 例) /images/games/\*.jpg
          * /\_/sports/\_.jpg
          * /images/sports/ac?e/\*.jpg
    * 全体ファイル：キャッシュされたファイルを全て削除します。オリジンサーバーに膨大なトラフィックが流入する場合があるため注意してください。
4. 選択したキャッシュ再配布タイプに合わせて、再配布するファイルを指定します。
5. **キャッシュ再配布**ボタンをクリックして、再配布をリクエストします。

キャッシュ再配布は使用量制限があるため、下記の表を参照して使用量が超過しないように注意してください。

|分類 |[サービスID].cdn.toastcloud.com|[サービスID].toastcdn.net |
|---|---|---| 
| 制限単位 | サービスドメイン別| プロジェクト別(AppKey) |
| 特定ファイル | 1時間に60回リクエスト可能、リクエスト毎のPath数制限：1,000個 | 1秒間に1回リクエスト可能、リクエスト毎のURL数制限：200 URLs | 
| ワイルドカード |  1時間に60回リクエスト可能、リクエスト毎のPath数制限：10個 | 未サポート | 
| 全体ファイルタイプ | 1時間に5回リクエスト可能 | 5分毎のリクエスト可能数：1回 | 

> **[注意]複数のドメインエイリアスを使用中のサービスID].cdn.toastcloud.comサービスのキャッシュ再配布**
> 複数のドメインエイリアスが登録されたCDNサービスは、リクエストしたパージパスに対してドメインエイリアスごとにパージ作業が行われます。
> 
> (例)
> `custom1.domain-alias.com`と`custom2.domain-alias.com`がドメインエイリアスに設定されたCDNサービスがあると仮定します。
> 上記CDNサービスに対して**特定ファイル**タイプでパージパス`/images/photo.png`にパージをリクエストした場合、下記2個のパージパスでパージが実行されます。 
>
> - custom1.domain-alias.com/images/photo.png
> - custom2.domain-alias.com/images/photo.png 
>
> (登録されたドメインエイリアス数Xリクエストしたパージパス数)分のパージパスが追加されてパージが行われるため注意してください。 
> 全体パージパス数がパージリクエスト毎の最大パージパス数を超過した場合は、リクエスト毎の最大パージパス分、分割されてリクエストが行われます。
> 分割して進行したパージリクエストの数だけパージ使用量は増加するため、パージ使用量の超過に注意してください。
>
> **[注意] [サービスID].toastcdn.comサービスの作成後、キャッシュ再配布失敗エラー**
> CDNサービスを作成した後、約1時間はキャッシュ再配布リクエストが失敗する場合があります。その後も継続して失敗する場合はサポートへお問い合わせください。

## 証明書の管理 
所有しているドメインでコンテンツをHTTPSで転送するには、所有しているドメインの証明書がCDNサーバーに配布されている必要があります。証明書が配布されていない場合、Client(browser)とCDNエッジサーバー間の暗号化通信(HTTPS)ができず、証明書エラーが発生します。
TOAST CDNの証明書管理は次のような機能を提供します。

- 単一ドメインタイプの証明書発行
- 全世界の拠点のCDNサーバーに証明書を配布(ただし、中国とロシアは除外されます。)
- 証明書満了前の自動更新

### 新規証明書の発行 
証明書を発行するには、**証明書管理**タブに移動して新規発行リクエストを行います。
![CDN新規証明書の発行](https://static.toastoven.net/prod_cdn/v2/console-certificate-create.png)

1. **証明書管理**タブの**新規証明書発行**ボタンをクリックします。
2. 発行する証明書のドメインを全体ドメインアドレス(FQDN、fully qualified domain name)形式で入力します。
3. 証明書発行案内の内容を確認し、**確認**ボタンをクリックします。
4. 新規証明書の発行をリクエストすると、**証明書管理**タブの証明書ドメインが表示されます。証明書の状態が**ドメイン検証**状態に変更された後にドメイン検証作業を進行してください。 

> **[注意]証明書発行前の確認事項**
> 1. 所有しているドメインのみ証明書の発行が可能なため、先にドメインを購入してから進行してください。 
> 2. 他のCAで発行した証明書は利用できません。 
> 3. 単一ドメインの証明書の発行のみ可能です。(ワイルドカード、マルチドメインなどの証明書はサポートしません。)
> 4. 証明書の発行はプロジェクトごとに5個に制限されます。限度の調整が必要な場合はTOASTサポートへお問い合わせください。
> 5. 新規証明書の発行をリクエストした後、ドメイン検証段階は数十分(最大1～2時間)後に変更される場合があります。証明書の状態がドメイン検証状態に変更されたらTOASTプロジェクトメンバーを対象にメール送信がされます。もしシステムエラーによりメールが送信されなかった場合、コンソールで状態を確認してください。 

### ドメイン検証 
新規証明書の発行をリクエストした後、証明書の状態が｢ドメイン検証｣状態になったらドメインの検証を行ってください。
ドメインの検証方法は、コンソールでドメインを選択して確認するか、プロジェクトメンバーに転送されたドメイン検証ガイドメールの内容を参照してください。

![CDNドメイン検証](https://static.toastoven.net/prod_cdn/v2/console-certificate-domain-validation.png)

ドメイン検証は、発行をリクエストした証明書ドメインの実際の所有者であることを確認する段階です。ドメイン検証を行っていない場合、証明書の発行ができません。
ドメインの所収者であることを確認するために、ドメイン検証方式を通してドメインの制御権限を確認します。 
ドメイン検証方式は、**DNS TXTレコード追加**または**HTTPページ追加**方式があります。**2つの方式のうち1つを進行**してください。

![CDNドメイン検証](https://static.toastoven.net/prod_cdn/v2/console-certificate-domain-validation2.png)

#### DNS TXTレコード追加方式 
ドメインのDNS制御権限を確認してドメイン検証を行います。

1. ドメインのDNSサービス提供業者のDNS管理ページでTXTレコードを追加します。(DNSの設定方法はDNSサービス提供業者によって異なる場合があります。この設定については該当サービス業者にお問い合わせください。)
  - レコードタイプ：**TXT**
  - TTL：**60**(60に設定できない場合はできるだけ小さい値を設定してください。)
  - レコード名：**_acme-challenge.[発行をリクエストした証明書ドメイン].**(コンソールまたは送信されたメールガイドの**レコード名**を作成します。)
  - レコード値：**任意の文字列**(コンソールまたは送信されたメールガイドの**レコード値**を作成します。)

2. nslookupコマンドを使い、追加したTXTレコードを確認します。(DNS配信時間に応じて確認できるまで時間がかかる場合があります。)
  `nslookup -type=TXT **_acme-challenge.[発行リクエストした証明書ドメイン].**`

次の画面はTOAST DNS+ サービスで設定した例です。DNSサービス提供業者によって設定方法は異なる場合があります。
![CDNドメイン検証](https://static.toastoven.net/prod_cdn/v2/console-certificate-domain-validation-dns.png)


#### HTTPページ追加方式 
ドメインが接続されたWebサーバーにHTTPページを追加してドメイン検証を行います。

1. Webサーバーの**http://[発行リクエストした証明書ドメイン]/.wellkonw/acme-challenge/[任意の文字列]**パスにHTTPページを追加します。 
2. HTTPページの本文にコンソールまたは送信されたメールガイドの**ページコンテンツ(トークン)**の値を設定します。 
3. Webブラウザで**http://[発行リクエストした証明書ドメイン]/.wellkonw/acme-challenge/[任意の文字列]**URLで接続したら**ページコンテンツ(トークン)**の値が画面に表示されるかを確認します。 

> **[注意]ドメイン検証の注意事項**
> 1. ドメイン検証は、証明書発行リクエストを行った日から**5日以内**に進行する必要があります。**期間内に進行しなかった場合、証明書の発行は自動キャンセル処理**されます。
> 2. ドメイン検証作業完了後、検証が成功したら数時間で証明書の発行および配布作業が行われます。1日以上進行されない場合、ドメイン検証作業の内容が正しいかを確認します。正しいにもかかわらず進行されない場合はTOASTサポートへお問い合わせください。
> 3. ドメイン検証方式のHTTPページ追加方式は、HTTPサーバーが基本ポート80で運用中の場合にのみ可能です。ポートの変更ができない場合、DNS TXTレコード追加方式を利用してください。

### 証明書の発行および配布
ドメイン検証に成功したら、数時間以内に証明書の発行および配布作業が進行されます。 
この段階の作業が進行されると、コンソールで証明書の状態が**証明書発行および配布**段階と表示され、TOASTプロジェクトメンバーを対象に通知メールが送信されます。 
この段階では別途作業する内容はありません。

>  **[参考]証明書の発行と配布段階の作業時間**
> 証明書の発行および配布作業は最大9時間以上かかる場合があります。 

### CDNサービス連携
発行された証明書を利用するには、CDNサービスと連携する必要があります。 
この作業を行わなかったり、作業内容を維持しない場合、発行された証明書が無効になる場合があるため、注意してください。 

1. **CNAMEレコード設定**：証明書ドメインのDNSサービス提供業者のDNS管理で、次のCNAMEレコードを追加します。 
    - レコードタイプ：**CNAME**
    - TTL：任意の値(頻繁な変更が予想される場合は小さい値を設定することを推奨します。レコード変更時、キャッシュDNSサーバーにTTL時間中キャッシュされる場合があります。)
    - レコード名：**[証明書ドメイン].**(例： test.alias.com.com.)
    - レコード値：**[連携するCDNサービスドメイン]**(例：xxxxxxxx.toastcdn.net)
次の画面はTOAST DNS+ サービスで設定した例です。DNSサービス提供業者によって設定方法は異なる場合があります。
![CDNサービス連携-CNAME委任](https://static.toastoven.net/prod_cdn/v2/console-certificate-service-cname.png)

2. **ドメインエイリアス設定**：証明書を利用するCDNサービスにドメインエイリアス設定を追加します。
    -  **CDNサービス**タブ > 連携するCDNサービス選択 >  **修正**ボタン > ドメインエイリアスに証明書ドメインを追加して**確認**ボタンをクリックして修正します。
![CDNサービス連携-ドメインエイリアス](https://static.toastoven.net/prod_cdn/v2/console-certificate-service-alias.png)


>  **[注意]証明書満了注意事項**
> TOAST CDNで提供する証明書は、証明書が無効になる前に自動的に証明書を更新します。
> 自動的に証明書の更新が行われるには、使用中の証明書がCDNサービスと連携している必要があります。
> CDNサービスと連携していない証明書は、証明書更新期間に証明書を更新することができず、無効になる場合があります。
> 証明書の更新は**証明書管理** > リストに表示された証明書更新開始日から**5日以内**に行われます。
> 証明書が無効にならないように、次の設定事項を常に維持してください。
> 
> 1. 証明書のドメインは、CNAMEレコードに連携するCDNサービスドメインアドレスに委任する必要があります。
> 2. 連携するCDNサービスのドメインエイリアスに証明書ドメインが設定されている必要があります。
> 3. 証明書が連携されたCDNサービスを一時停止すると、証明書を更新できません。証明書の更新開始日前に再開するか、他の運用中のCDNサービスに証明書を連携してください。
> 4. 証明書が連携されたCDNサービスを削除すると、証明書を更新できません。削除する前に、他の運用中のCDNサービスに証明書を連携してください。 

CDNサービス連携作業が完了すると、証明書の状態が｢正常｣と表示されます。
![CDN証明書正常状態](https://static.toastoven.net/prod_cdn/v2/console-certificate-active.png)

## 統計

ネットワーク転送量、HTTP状態コード別の統計および、ダウンロードが最も多いコンテンツの順位統計を確認できます。
7日以内の統計データは正確ではないため、参考程度に利用してください。正確な統計データは7日後に確認してください。

1. **Contents Delivery > CDN**の**統計**タブをクリックします。
![cdn_08_201812](https://static.toastoven.net/prod_cdn/cdn_08_201812.png)
2. 統計を確認するには、CDNサービスを選択します。
3. 検索期間を入力します。
4. 検索期間内のデータ周期は、選択した期間に応じて自動的に選択されます。
5. **検索**ボタンをクリックします。
